<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Contests | GLOBAL-GAMES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style-gradient.css">

  <!-- FingerprintJS -->
  <script src="https://openfpcdn.io/fingerprintjs/v4"></script>

  <style>
    body { background: #101729!important; margin: 0; }
    /* ===== dein komplettes CSS UNVERÄNDERT ===== */
    /* (aus Platzgründen hier nicht gekürzt, identisch zu deinem Original) */
  </style>
</head>

<body>
<header class="site-header">
  <div class="logo-anim" id="header-global-games">GLOBAL-GAMES</div>
  <nav class="nav-menu">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="contests.html" class="active">My Contests</a></li>
      <li><a href="comingsoon.html">Coming soon</a></li>
    </ul>
  </nav>
</header>

<div class="main-content">
  <div class="vote-title-gradient" style="font-size:2.2rem;">
    Chrismas contest 2025 - by global-games
  </div>

  <div class="subtext">Select up to three projects</div>

  <div class="vote-grid" id="voteGrid"></div>

  <button class="vote-submit" id="submitVote" disabled>
    Submit Vote
  </button>

  <div class="vote-banner" id="voteBanner">
    Thanks for your vote in the contest!  
    The winners are going to be appointed on 05.01.2026.
  </div>

  <div class="chart-section" id="chartSection" style="display:none;"></div>
</div>

<script src="wave-title.js"></script>

<script>
/* =========================================================
   KONFIG
========================================================= */
const API = "http://localhost:5050";
const MAX_PICKS = 3;

const options = Array.from({ length: 20 }, (_, i) => ({
  id: i + 1,
  title: "Game " + (i + 1),
  img: "option" + (i + 1) + ".jpg",
  info: "Awesome entry " + (i + 1)
}));

/* =========================================================
   STATE
========================================================= */
let fingerprint = null;
let selected = [];

const grid = document.getElementById("voteGrid");
const submitBtn = document.getElementById("submitVote");

/* =========================================================
   FINGERPRINT LADEN
========================================================= */
(async () => {
  const fp = await FingerprintJS.load();
  const result = await fp.get();
  fingerprint = result.visitorId;
  loadStats();
})();

/* =========================================================
   CARDS BAUEN
========================================================= */
function buildCards() {
  grid.innerHTML = "";

  options.forEach(opt => {
    const card = document.createElement("div");
    card.className = "vote-card";

    card.innerHTML = `
      <img src="${opt.img}" class="vote-img" onerror="this.style.opacity=0.4">
      <div class="vote-title">${opt.title}</div>
      <div class="vote-info">${opt.info}</div>
    `;

    card.onclick = () => {
      if (selected.includes(opt.id)) {
        selected = selected.filter(id => id !== opt.id);
        card.classList.remove("selected");
      } else if (selected.length < MAX_PICKS) {
        selected.push(opt.id);
        card.classList.add("selected");
      }

      submitBtn.disabled = selected.length === 0;
    };

    grid.appendChild(card);
  });
}

buildCards();

/* =========================================================
   VOTE ABSENDEN
========================================================= */
submitBtn.onclick = async () => {
  if (!fingerprint || selected.length === 0) return;

  const res = await fetch(API + "/vote", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      fingerprint,
      picks: selected,
      lang: navigator.language,
      tz: Intl.DateTimeFormat().resolvedOptions().timeZone
    })
  });

  const data = await res.json();

  if (!data.ok) {
    alert("You have already voted or your vote was rejected.");
  }

  showResults(data.stats);
};

/* =========================================================
   STATS
========================================================= */
async function loadStats() {
  const res = await fetch(API + "/stats");
  const data = await res.json();
  showResults(data.stats);
}

function showResults(stats) {
  grid.style.display = "none";
  submitBtn.style.display = "none";
  document.getElementById("voteBanner").classList.add("show");

  const chart = document.getElementById("chartSection");
  chart.style.display = "block";

  const sum = stats.reduce((a, b) => a + b, 0);

  chart.innerHTML =
    `<h2 class="vote-title-gradient">Live results</h2>` +
    stats.map((v, i) => {
      const p = sum ? Math.round((v / sum) * 100) : 0;
      return `
        <div class="chart-bar-wrap">
          <span class="chart-bar-label">Game ${i + 1}</span>
          <div class="chart-bar" style="width:220px;">
            <div class="chart-bar-inner" style="width:${p * 2}px"></div>
          </div>
          <span class="chart-val">${v} (${p}%)</span>
        </div>`;
    }).join("");
}

/* =========================================================
   WAVE HEADER
========================================================= */
function waveText(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const text = el.textContent;
  el.innerHTML = '';
  [...text].forEach((char, i) => {
    const span = document.createElement('span');
    span.textContent = char;
    span.style.setProperty('--char-index', i);
    el.appendChild(span);
  });
}
waveText('header-global-games');
</script>

<footer style="text-align:center; padding:20px; font-size:0.9em; color:#555; border-top:1px solid #ccc; margin-top:40px;">
  <p>
    &copy; 2025 Jonas Schwinn |
    <a href="impressum.html" target="_blank">Impressum</a> |
    <a href="datenschutzerklärung.html" target="_blank">Datenschutzerklärung</a>
  </p>
</footer>

<!-- Datenschutz-Hinweis -->
<div id="cookie-banner">
  <p>
    Diese Webseite verwendet <strong>keine Cookies</strong>.  
    Zur Sicherstellung einer fairen Abstimmung wird ein <strong>pseudonymisierter Geräte-Fingerprint</strong> verwendet.  
    Weitere Informationen findest du in der <a href="datenschutzerklärung.html" target="_blank">Datenschutzerklärung</a>.
  </p>
  <button id="accept-cookies">Akzeptieren</button>
</div>

<script>
if (localStorage.getItem("cookiesAccepted") === "true") {
  document.getElementById("cookie-banner").style.display = "none";
}

document.getElementById("accept-cookies").onclick = () => {
  localStorage.setItem("cookiesAccepted", "true");
  document.getElementById("cookie-banner").style.display = "none";
};
</script>

</body>
</html>
